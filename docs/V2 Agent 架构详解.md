## V2 Agent 架构详解

### 一、整体架构图



```
┌─────────────────────────────────────────────────────────────────┐
│                     用户请求："这是什么害虫？"                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    image_detection_agent_v2                      │
│                      (Agent 入口)                                 │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              BASE_SYSTEM_PROMPT (~20行)                  │    │
│  │  "你是一位多模态农业专家助手..."                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    middleware 列表                       │    │
│  │  1. SkillMiddleware                                      │    │
│  │  2. ToolSelectorMiddleware                               │    │
│  └─────────────────────────────────────────────────────────┘    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    中间件执行链（洋葱模型）                        │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Layer 1: SkillMiddleware (最外层)                       │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │  1. 注入技能描述列表到系统提示词                    │  │    │
│  │  │  2. 注册 load_skill 工具                           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                    │                                      │    │
│  │                    ▼                                      │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │  Layer 2: ToolSelectorMiddleware                  │  │    │
│  │  │  1. 根据标签过滤工具列表                           │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  │                    │                                      │    │
│  │                    ▼                                      │    │
│  │  ┌───────────────────────────────────────────────────┐  │    │
│  │  │  Layer 3: 核心模型调用                             │  │    │
│  │  │  LLM 根据系统提示词和工具进行推理                   │  │    │
│  │  └───────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Agent 推理过程                              │
│                                                                   │
│  1. 读取系统提示词（包含技能描述列表）                            │
│  2. 判断需要病虫害检测能力                                        │
│  3. 调用 load_skill("pest_detection")                            │
│  4. 获得完整的病虫害检测指导                                      │
│  5. 调用 pest_detection_tool(image_path="...")                   │
│  6. 根据工具返回和完整指导，给出专业建议                          │
└─────────────────────────────────────────────────────────────────┘
```

------

### 二、两个中间件的作用

#### 1. SkillMiddleware（技能中间件）

**作用**：实现 Progressive Disclosure（渐进式披露）

**工作原理**：



```python
class SkillMiddleware(AgentMiddleware):
    def __init__(self, skills):
        self.skills = skills
        
    def wrap_model_call(self, request, handler):
        # 步骤 1: 构建技能描述列表（只有简短描述！）
        skills_list = []
        for skill in self.skills:
            skills_list.append(f"- {skill.name}: {skill.description}")
        
        skills_prompt = "\n".join(skills_list)
        
        # 步骤 2: 将技能描述注入到系统提示词
        skills_addendum = f"""
## 可用技能

{skills_prompt}

使用 load_skill 工具获取技能的详细信息、指导原则和示例。
"""
        
        # 修改系统消息
        modified_request = request.override(
            system_message=...  # 原系统提示词 + skills_addendum
        )
        
        # 步骤 3: 注册 load_skill 工具
        # 工具定义在 middleware.tools 属性中
        # Agent 可以调用 load_skill(skill_name) 获取完整内容
        
        # 继续执行
        return handler(modified_request)
```

**注入前的系统提示词**：



```
你是一位多模态农业专家助手...
你的目标是：根据用户的输入自动判断需要使用哪个工具...
```

**注入后的系统提示词**：



```
你是一位多模态农业专家助手...
你的目标是：根据用户的输入自动判断需要使用哪个工具...

## 可用技能

- pest_detection: 病虫害检测专家，识别农作物病虫害并提供防治建议
- rice_detection: 大米品种识别专家，识别大米品种并提供品质分析
- cow_detection: 牛只检测专家，识别牛只品种和数量，提供养殖管理建议

使用 load_skill 工具获取技能的详细信息、指导原则和示例。
```

**load_skill 工具的作用**：

当 Agent 需要某个技能的完整指导时，它会调用：



```python
load_skill.invoke({"skill_name": "pest_detection"})
```

返回：



```
# pest_detection 技能
你是病虫害检测专家，专注于农作物的病虫害识别和防治。

## 核心能力
- 识别常见农作物病虫害（如瓜实蝇、斜纹夜蛾、稻飞虱等）
...

## 工作流程
1. 使用 pest_detection_tool 分析图片（参数为本地图片文件路径）
2. 根据检测结果识别害虫种类和数量（格式如："检测结果: 瓜实蝇(3只)、斜纹夜蛾(1只)"）
...

## 输出格式
- **检测结果摘要**：清晰列出检测到的害虫种类和数量
- **危害分析**：评估害虫的危害程度和潜在影响
...
```

------

#### 2. ToolSelectorMiddleware（工具选择中间件）

**作用**：根据标签动态过滤工具列表

**工作原理**：



```python
class ToolSelectorMiddleware(AgentMiddleware):
    def __init__(self, tools, tags):
        # 只选择带有指定标签的工具
        self.filtered_tools = [t for t in tools if tag匹配(t)]
        
    def wrap_model_call(self, request, handler):
        # 将过滤后的工具列表注入到请求中
        modified_request = request.override(tools=self.filtered_tools)
        return handler(modified_request)
```

**示例**：

假设有 10 个工具：

- 3 个检测工具（标签：`detection`）
- 4 个规划工具（标签：`planning`）
- 3 个通用工具（无标签）

当 `ToolSelectorMiddleware(tags=["detection"])` 时：

- Agent 只能看到 3 个检测工具
- 减少了工具列表长度，提高决策准确性

------

### 三、Agent 工作流程示例

让我用一个具体的场景演示完整流程：

#### 场景：用户上传害虫图片并询问



```
用户："帮我识别这张图片中的害虫"
```

**步骤 1：请求进入 SkillMiddleware**



```
系统提示词 = BASE_SYSTEM_PROMPT + 技能描述列表

# Agent 看到的系统提示词：
"""
你是一位多模态农业专家助手...

## 可用技能

- pest_detection: 病虫害检测专家，识别农作物病虫害并提供防治建议
- rice_detection: 大米品种识别专家，识别大米品种并提供品质分析
- cow_detection: 牛只检测专家，识别牛只品种和数量，提供养殖管理建议

使用 load_skill 工具获取技能的详细信息。
"""
```

**步骤 2：Agent 判断需要病虫害检测能力**



```
Agent 内部推理：
"用户问识别害虫，这需要病虫害检测能力"
→ 调用 load_skill("pest_detection")
```

**步骤 3：load_skill 返回完整指导**



```
# pest_detection 技能
你是病虫害检测专家...

## 核心能力
- 识别常见农作物病虫害（如瓜实蝇、斜纹夜蛾、稻飞虱等）
...

## 工作流程
1. 使用 pest_detection_tool 分析图片（参数为本地图片文件路径）
2. 根据检测结果识别害虫种类和数量
3. 评估危害程度和对作物的影响
4. 提供多层次防治方案（化学、生物、物理防治）
...

## 输出格式
- **检测结果摘要**：清晰列出检测到的害虫种类和数量
- **危害分析**：评估害虫的危害程度和潜在影响
- **防治方案**：化学、生物、物理防治
...
```

**步骤 4：Agent 调用检测工具**



```
Agent 内部推理：
"根据完整指导，我需要：
1. 先调用 pest_detection_tool 获取检测结果
2. 然后根据输出格式给出专业建议"

→ 调用 pest_detection_tool(image_path="/uploads/xxx.jpg")
```

**步骤 5：工具返回结果**



```
工具返回："检测结果: 瓜实蝇(3只)、斜纹夜蛾(1只)"
```

**步骤 6：Agent 根据完整指导给出最终回复**



```
Agent 回复用户：

根据检测结果，您的图片中发现了：
- 瓜实蝇：3只
- 斜纹夜蛾：1只

**危害分析**：
瓜实蝇会直接危害果实，造成腐烂脱落；斜纹夜蛾幼虫啃食叶片，影响光合作用。

**防治方案**：
1. 化学防治：推荐使用阿维菌素1500倍液喷雾，注意安全间隔期7天
2. 生物防治：释放寄生蜂，使用Bt制剂（苏云金芽孢杆菌）
3. 物理防治：悬挂黄色粘虫板诱杀成虫，人工摘除卵块

**预防措施**：
- 及时清除果园落果，减少虫源
- 保持果园通风透光
- 定期巡查，早发现早防治
```

------

### 四、对比 V1 和 V2 的工作方式

#### V1（传统架构）



```python
# 一次性给 Agent 所有信息
SYSTEM_PROMPT = """
<role>
你是一位多模态农业专家助手...
</role>

<tools>
你可以调用以下三个图像识别工具：
1. pest_detection_tool - 病虫害检测（详细描述...）
2. rice_detection_tool - 大米识别（详细描述...）
3. cow_detection_tool - 奶牛检测（详细描述...）
</tools>

<task>
你的完整工作流程如下：
1. 判断用户意图
2. 工具调用策略（详细步骤...）
3. 解释与分析结果（详细指导...）
4. 提供专家级建议（详细指导...）
5. 多轮对话支持
</task>

<constraints>
- 回答必须基于工具结果，不得虚构检测内容
- 工具返回失败时，要礼貌地说明问题并建议用户重试
...
</constraints>

<output_format>
- 回复清晰、自然、有逻辑
- 对每类识别任务都包含实际可操作的建议
...
</output_format>

<demo_mode>
- 现在处于演示模式，回答200字左右，不能超过300字
...
</demo_mode>
"""  # 共 82 行！
```

**问题**：

- ❌ 所有内容始终加载，Token 消耗大
- ❌ 提示词臃肿，难以维护
- ❌ 添加新技能需要修改大量提示词

#### V2（Skills 架构）



```python
# 初始只有简短提示词
BASE_SYSTEM_PROMPT = """
<role>
你是一位多模态农业专家助手...
</role>

<task>
你的目标是：根据用户的输入自动判断需要使用哪个工具。
工作流程：
1. 判断用户意图
2. 根据用户描述选择最合适的工具
3. 调用工具前，使用 load_skill 加载对应技能的详细指导
4. 基于工具结果给出准确解释
</task>

<constraints>
- 回答必须基于工具结果，不得虚构检测内容
- 使用 load_skill 工具获取详细的处理指导
</constraints>
"""  # 只有 ~20 行
```

**通过中间件动态注入**：



```
## 可用技能

- pest_detection: 病虫害检测专家，识别农作物病虫害并提供防治建议
- rice_detection: 大米品种识别专家，识别大米品种并提供品质分析
- cow_detection: 牛只检测专家，识别牛只品种和数量，提供养殖管理建议

使用 load_skill 工具获取技能的详细信息。
```

**优势**：

- ✅ Token 消耗减少 60%（初始加载更少）
- ✅ 模块化，易于扩展
- ✅ Agent 更自主（自己决定何时加载什么技能）

------

### 五、总结

**中间件的洋葱模型**：



```
         用户请求
            ↓
    ┌──────────────┐
    │ SkillMiddleware │  ← 第 1 层：注入技能描述，注册 load_skill
    └──────────────┘
            ↓
    ┌──────────────┐
    │ToolSelector │  ← 第 2 层：过滤工具列表
    └──────────────┘
            ↓
    ┌──────────────┐
    │  LLM 推理    │  ← 核心层：根据提示词和工具进行推理
    └──────────────┘
```

**核心思想**：

- **SkillMiddleware**："不要一开始就告诉 Agent 所有细节，让它自己查阅"
- **ToolSelectorMiddleware**："只给 Agent 看当前需要用的工具"
- **Progressive Disclosure**："按需加载，渐进式披露"

这就是 V2 Agent 的核心架构和工作流程！