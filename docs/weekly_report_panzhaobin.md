## 2025-12-week2&3（12.5 - 12.18）周报日志（潘兆斌）

### 一、主要进展

- 系统学习 FastAPI 框架，完成第一个 FastAPI 示例程序，掌握路由机制；
- 学习并实践 FastAPI 三种参数类型（路径参数、查询参数、请求体参数）以及多种响应类型（JSON、HTML、文件及自定义响应）；
- 学习 FastAPI 的异常处理机制、中间件和依赖注入用法，并将其应用到实际项目中；
- 使用 FastAPI 封装后端 Agent 层服务，为前后端交互提供统一接口；
- 在 GitHub Copilot 辅助下完成项目后端服务层与前端初始代码，并完成 Node.js 环境配置；
- 实现前端静态页面 Demo，用于演示系统整体交互流程与预期展示效果；
- 在 system prompt 中引入 `<demo_mode>`，用于调试和演示场景下控制大模型输出；
- 持续优化静态页面 Demo：
  - 引入工具调用卡片，直观展示 Agent 的工具调用过程；
  - 将检测结果图片嵌入工具调用卡片，并支持展开查看；
  - 添加乡村场景相关元素，优化页面图文比例与整体观感；
- 使用 Next.js 初步实现前端界面，逐步替换静态 Demo；
- 在前端界面中实现工具调用事件处理与工具调用卡片的动态展示；
- 实现多张图片批量上传功能，提升前端交互能力；
- 更新并完善前端使用指南相关文档；
- 对流式输出功能进行了初步尝试，目前后端已有相关实现思路，但前端暂未达到预期展示效果。

### 二、遇到的问题与思考

- 当前前端对 Agent 流式输出的支持仍不完善，存在后端已有流式返回但前端无法正确渲染的问题，后续需要进一步梳理 FastAPI StreamingResponse 与前端事件流（如 SSE / WebSocket）的配合方式；


## 2025-12-week1（11.28 - 12.4）周报日志（潘兆斌）

### 一、本周主要进展

- 优化 system prompt：移除Agent从图片路径推断意图的逻辑，改为主动询问用户图片用途，提高交互准确性；
- 设计一个贴近实际场景的14轮对话 Demo；
- 实现 SummarizationMiddleware，对历史对话进行摘要，优化模型上下文管理；
- 完成通用模型管理类初步开发，支持 Agent 在大模型之间切换；
- 将 FastAPI 重构后的害虫检测服务集成到 RuralBrain 项目中，通过 Docker 完成本地部署并测试接口文档；
- 根据新的FastAPI服务重构 pest_detection_tool.py，保证调用逻辑、入参与出参规范一致；

### 二、遇到的问题与思考

- 用14轮对话demo进行测试，输入输出总计将近18000字，不利于展示，可能的解决方案：
  1、调整system prompt，要求大模型简洁输出（添加 <demo_mode> 或者直接更改系统提示词）；
  2、配置模型时设置max_token限制大模型输出token数。


## 2025-11-week4（11.21 - 11.27）周报日志（潘兆斌）

### 一、本周主要进展

- 完成 `feature/pest-detection-agent` → `dev`、`origin/feature/rice_recognization` → `dev`、`cow_detection_agent` → `dev` 等分支合并工作；
- 重新整理了项目整体目录结构，清理冗余文件，将各 Agent、工具与资源归类到正确位置；
- 完成 rice detection agent、cow detection agent 的功能测试，修复部分输出与调用逻辑问题；
- 新增 `image_detection_agent.py`，实现单 Agent 模式下的初步统一调用逻辑；
- 为避免模型从图片路径中“猜测类别”，新增混合测试图片数据集，并调整测试方案；
- 优化 system prompt，当 Agent 无法判断图片类型时，会主动询问用户；
- 编写多种测试脚本，验证 Agent 的基础检测、对话能力、混合输入处理以及底层算法工具的误判情况；

### 二、遇到的问题与思考

- **测试图像检测agent时，agent会从图片路径中提取信息来决定调用哪个检测工具，如果图片路径中不包含信息，agent无法判断需要调用哪一个工具，则会同时调用三个工具。**
- **此时部分算法工具会出现误检的情况，即输入一张牛的图片，害虫检测工具会检测出害虫，最后agent也会输出检测出害虫的结果。**
- 可能的解决方案：
  - 方案一:图像预分类(推荐) ：在调用具体检测工具前,先对图片进行快速分类判断,确定图片类型,再调用对应工具。
  - 方案二:多模态大模型识别：利用支持视觉的大模型(如 GPT-4V、Claude等)直接理解图片内容,判断属于哪一类。
  - 方案三:全工具尝试 + 置信度筛选：依次调用所有工具,根据置信度选择最可能的结果。
  - 方案四:增强用户交互：主动询问用户图片内容类型。**（已初步实现）**


## 2025-11-week3（11.14 - 11.20）周报日志（潘兆斌）

### 一、本周主要进展

- 编写 `pest_detection_agent.py` 和 `pest_detection_tool.py`，完成工具与 Agent 的初步封装；
- 将 Agent 回答改为流式输出，提高用户交互体验；
- 使用 `checkpointer` 实现 memory，使 Agent 支持多轮对话；
- 用 XML 格式重写 system prompt，将其划分为四个部分：角色说明、工具调用、任务描述与任务完成指南，以及输出规范；
- 与团队统一底层 tools 规范，明确 `/detect` 接口的输入输出格式。

### 二、遇到的问题

| 问题                  | 分析和思考                                                   |
| --------------------- | ------------------------------------------------------------ |
| Tool Message 输出异常 | Agent 接受图片路径后疑似把 Tool Message 检测结果一并输出，有待解决 |
| Tool 输出格式探索     | LangChain / LangGraph 中 Tool 输出使用 JSON 字符串格式，需进一步探索正确处理方式 |
| 多图片并发调用问题    | 同时传三张图片时，Agent 若并发调用检测服务，可能出现竞态条件导致结果覆盖。解决方法：让底层识别服务做到天然的无状态（stateless）、无共享全局变量、线程/进程安全，并在 FastAPI 层统一重构？ |


## 2025-11-week2（11.7 - 11.13）周报日志（潘兆斌）

### 一、本周主要进展

- 完成害虫识别工具的封装 Demo，成功调用检测本地实例图片；
- 完成 GitHub 学生认证与 Copilot Pro 激活，为后续代码协作与提升开发效率做好准备；
- 与崔少旭同学对接病虫害识别模块重构规划，明确三阶段实施路线：
  - **第一阶段（本周）**：明确需求与接口方向，产出概要设计（架构图、模块划分、数据流）；
  - **第二阶段（下周）**：细化接口与数据结构，产出详细设计文档；
  - **第三阶段（第三周）**：完成 FastAPI + Docker 改造与 Agent 调用测试；
- 针对病虫害识别功能进行了多轮讨论，统一了认知，为后续重构奠定基础；
- 规划并确认了 Python 工程化的项目结构，为后续统一仓库组织方式提供参考。

### 二、遇到的问题与处理

- 病虫害识别模块现阶段为单体 Flask 应用，与整体项目架构不统一 → 已规划重构方案（FastAPI + 标准接口）；