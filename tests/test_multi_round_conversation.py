"""
å¤šè½®å¯¹è¯è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
æµ‹è¯•åœºæ™¯ï¼šæ¨¡æ‹Ÿä¸€ä¸ªä¸œåŒ—å†œåœºä¸»ä»äº†è§£ç³»ç»Ÿåˆ°è§„åˆ’å†œåœºå‘å±•çš„å®Œæ•´å¯¹è¯æµç¨‹
åŒ…å«ï¼šå¤§ç±³è¯†åˆ«ã€å®³è™«è¯†åˆ«ã€ç‰›åªè¯†åˆ«ä»¥åŠç»¼åˆå†œåœºè§„åˆ’å»ºè®®
"""
from dotenv import load_dotenv
import sys
import time
from pathlib import Path
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

print("æ­£åœ¨åŠ è½½ AI æ¨¡å‹å’Œå·¥å…·...")
sys.stdout.flush()

from src.agents.image_detection_agent import agent as image_detection_agent
from langchain_core.messages import HumanMessage, AIMessageChunk

print("âœ“ ç³»ç»ŸåŠ è½½å®Œæˆï¼\n")


# å®šä¹‰ 15 è½®å¯¹è¯è„šæœ¬
CONVERSATION_ROUNDS = [
    {
        "round": 1,
        "title": "äº†è§£AgentåŸºæœ¬åŠŸèƒ½",
        "user_input": "ä½ èƒ½å¸®æˆ‘åšä»€ä¹ˆï¼Ÿ"
    },
    {
        "round": 2,
        "title": "æœ´å®å†œæ°‘ï¼Œè§¦å‘å¤§ç±³è¯†åˆ«",
        "user_input": "æˆ‘åœ¨é»‘é¾™æ±Ÿè¿™è¾¹æ¾å«©å¹³åŸç§äº†ç‚¹æ°´ç¨»ï¼Œè‡ªå·±ç•™ç€åƒçš„ã€‚ä»Šå¹´åˆšæ”¶å®Œè°·å­ï¼Œæˆ‘çœ‹ç€è¿™å‡ è¢‹ç±³ä¹Ÿåˆ†ä¸å¤ªæ¸…å•¥å“ç§ï¼Œè€çœ¼æ˜èŠ±äº†ã€‚æˆ‘æ‹äº†ä¸€å¼ ç±³çš„ç…§ç‰‡ï¼Œä½ å¸®æˆ‘çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆå¤§ç±³å§ã€‚å›¾ç‰‡è·¯å¾„ï¼štests\\resources\\rice\\1.jpg"
    },
    {
        "round": 3,
        "title": "ç»§ç»­èŠå¤§ç±³ï¼ŒåŠä¸“ä¸šä¸€ç‚¹",
        "user_input": "ä½ åˆšæ‰è¯´çš„è¿™ä¸ªç±³çš„å“ç§ï¼Œæœ‰å•¥ç‰¹ç‚¹å—ï¼Ÿå£æ„Ÿã€é€‚åˆæ€ä¹ˆåšé¥­ï¼Œç®€å•è·Ÿæˆ‘è¯´è¯´å‘—ï¼Œæˆ‘å¹³æ—¶å°±çˆ±åƒç±³é¥­ã€ç†¬ç‚¹ç²¥ã€‚"
    },
    {
        "round": 4,
        "title": "å¼€å§‹è¿‡æ¸¡åˆ°ç”°é—´é—®é¢˜ï¼Œè§¦å‘å®³è™«è¯†åˆ«",
        "user_input": "è¿™ä¸¤å¤©æˆ‘ä¸Šç”°é‡Œè½¬äº†ä¸€åœˆï¼Œå‘ç°æœ‰äº›æ°´ç¨»å¶å­è¢«è™«å­å’¬å¾—æŒºå‰å®³ã€‚æˆ‘æ‹äº†ä¸€å¼ ç”°é‡Œå®³è™«çš„ç…§ç‰‡ï¼Œä½ å¸®æˆ‘çœ‹çœ‹è¿™æ˜¯ä»€ä¹ˆè™«å­ã€‚å›¾ç‰‡è·¯å¾„ï¼štests\\resources\\pests\\1.jpg"
    },
    {
        "round": 5,
        "title": "åŠ ä¸Šåœ°åŸŸ + åŠä¸“ä¸šå†œåœºä¸»å£å»ï¼Œé—®é˜²æ²»",
        "user_input": "æˆ‘ä»¬è¿™å—æ˜¯åœ¨é»‘é¾™æ±Ÿï¼Œæ°”å€™æ¯”è¾ƒå†·ï¼Œç§çš„æ˜¯ç²³ç¨»ã€‚å¦‚æœåœ¨æˆ‘ä»¬è¿™è¾¹å‡ºç°ä½ è¯´çš„è¿™ç§å®³è™«ï¼Œä¸€èˆ¬ä¼šå¯¹äº§é‡å½±å“å¤§ä¸å¤§ï¼Ÿæˆ‘åº”è¯¥æ€ä¹ˆé˜²æ²»ï¼Œæ—¢åˆ«å¤ªä¼¤åœ°ï¼Œåˆå°½é‡åˆ«å½±å“æ”¶æˆï¼Ÿ"
    },
    {
        "round": 6,
        "title": "è¿›ä¸€æ­¥é—®é¢„é˜² + ç®¡ç†",
        "user_input": "é™¤äº†æ‰“è¯è¿™å—ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ¯”è¾ƒç¨³å¦¥ä¸€ç‚¹çš„é¢„é˜²åŠæ³•ï¼Ÿæ¯”å¦‚è¯´ç”°é—´ç®¡ç†ã€æ ½åŸ¹æ–¹å¼ä¸Šï¼Œæˆ‘èƒ½ä¸èƒ½æ—©ç‚¹åšç‚¹å•¥ï¼Œåˆ«ç­‰è™«å­å¤šäº†æ‰æ‰‹å¿™è„šä¹±ã€‚"
    },
    {
        "round": 7,
        "title": "è½¬åœºåˆ°ç‰›ï¼Œè§¦å‘ç‰›è¯†åˆ«",
        "user_input": "æˆ‘å®¶è¿˜å…»äº†å‡ å¤´ç‰›ï¼Œéƒ½æ˜¯å’±è¿™è¾¹å¸¸è§çš„é»„ç‰›ã€è¿˜æœ‰ç‚¹æœ¬åœ°æ‚äº¤è‚‰ç‰›ã€‚æˆ‘æ‹äº†ä¸€å¼ ç‰›åœˆçš„ç…§ç‰‡ï¼Œä½ å¸®æˆ‘æ•°æ•°æœ‰å‡ å¤´ç‰›ã€‚å›¾ç‰‡è·¯å¾„ï¼štests\\resources\\cows\\1.jpg"
    },
    {
        "round": 8,
        "title": "åŠä¸“ä¸šå†œåœºä¸»è¯­æ°”ï¼Œé—®ç‰›åªé¥²å…»ç®¡ç†",
        "user_input": "å¦‚æœæ˜¯è¿™ç§æœ¬åœ°é»„ç‰›æˆ–è€…æ‚äº¤è‚‰ç‰›çš„è¯ï¼Œåœ¨æˆ‘ä»¬æ¾å«©å¹³åŸè¿™è¾¹ï¼Œé¥²å…»ä¸Šæœ‰ä»€ä¹ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„å—ï¼Ÿæ¯”å¦‚é¥²æ–™æ­é…ã€åœˆèˆç¯å¢ƒä¹‹ç±»çš„ï¼Œä½ ç»™æˆ‘æå‡ æ¡è¦ç‚¹å°±è¡Œã€‚"
    },
    {
        "round": 9,
        "title": "æŠŠç§æ¤å’Œå…»æ®–ä¸²èµ·æ¥",
        "user_input": "æˆ‘ä¸€ç›´åœ¨æƒ³ï¼Œæ—¢ç„¶æˆ‘è¿™è¾¹æœ‰æ°´ç¨»ï¼Œè¿˜æœ‰ç‰›ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æŠŠç§åœ°å’Œå…»ç‰›ç»“åˆèµ·æ¥ï¼Ÿæ¯”å¦‚ç§¸ç§†åˆ©ç”¨å•Šã€ç‰›ç²ªè¿˜ç”°å•Šï¼Œä½ è§‰å¾—åƒæˆ‘ä»¬è¿™ç§è§„æ¨¡ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå®æ‰“å®ã€èƒ½è½åœ°çš„åšæ³•ï¼Ÿ"
    },
    {
        "round": 10,
        "title": "èº«ä»½å¾€\"å†œåœºç»è¥è€…/åˆä½œç¤¾\"é ",
        "user_input": "ç°åœ¨æˆ‘è¿™è¾¹å¤§æ¦‚æœ‰ 50 äº©åœ°ï¼Œä¸»è¦æ˜¯æ°´ç¨»ï¼Œç‰›çš„è¯å…ˆå…»ä¸ªåæ¥å¤´ï¼Œæ…¢æ…¢å†æ‰©å¤§ç‚¹è§„æ¨¡ã€‚ä»ä½ åˆšæ‰è¯†åˆ«çš„å¤§ç±³å“ç§ã€å®³è™«æƒ…å†µï¼Œè¿˜æœ‰ç‰›çš„æƒ…å†µæ¥çœ‹ï¼Œä½ è§‰å¾—æˆ‘è¿™å—è¦æ˜¯å¾€\"å®¶åº­å†œåœº\"æˆ–è€…\"å°å‹åˆä½œç¤¾\"æ–¹å‘å‘å±•ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ€è·¯ï¼Ÿ"
    },
    {
        "round": 11,
        "title": "è¦æ±‚æ•´ä½“è§„åˆ’ï¼Œæ˜ç¡®ä¿¡æ¯",
        "user_input": """æˆ‘å†ç»™ä½ æ‹ä¸€ä¸‹æˆ‘å®¶çš„æƒ…å†µï¼š
- åœ°åŒºï¼šé»‘é¾™æ±Ÿæ¾å«©å¹³åŸ
- ç§æ¤é¢ç§¯ï¼šå¤§æ¦‚ 50 äº©æ°´ç¨»
- å¤§ç±³å“ç§ï¼šä½ åˆšæ‰è¯†åˆ«å‡ºæ¥çš„é‚£ä¸ª
- å®³è™«ï¼šæœ€è¿‘ç”°é‡Œæ‹åˆ°çš„å°±æ˜¯ä½ åˆšæ‰è¯†åˆ«çš„é‚£ç§
- ç‰›ï¼šæœ¬åœ°é»„ç‰›å’Œæ‚äº¤è‚‰ç‰›ï¼Œä½ åˆšæ‰æ•°è¿‡äº†

ä½ åŸºäºè¿™äº›ä¿¡æ¯ï¼Œå¸®æˆ‘è§„åˆ’ä¸€ä¸‹æ¥ä¸‹æ¥ 3â€“5 å¹´ï¼Œæˆ‘è¿™ä¸ªå°å†œåœº/åˆä½œç¤¾å¯ä»¥æ€ä¹ˆå‘å±•ï¼ŸåŒ…å«ï¼š
1ï¼‰æ°´ç¨»ç§æ¤å’Œå“ç§é€‰æ‹©
2ï¼‰å®³è™«é˜²æ²»å’Œç”°é—´ç®¡ç†
3ï¼‰ç‰›åªå…»æ®–è§„æ¨¡å’Œç®¡ç†
4ï¼‰ç§æ¤ + å…»æ®–æ€ä¹ˆé…åˆç€æ¥æå¾—æ›´é•¿è¿œä¸€ç‚¹"""
    },
    {
        "round": 12,
        "title": "è¦æ±‚ç»™å‡ºæ›´ç»†ä¸€ç‚¹çš„æ—¶é—´å®‰æ’",
        "user_input": "ä½ åˆšæ‰è¯´çš„é‚£äº›æ–¹å‘éƒ½æŒºå¥½ï¼Œä½ èƒ½ä¸èƒ½æŒ‰ç…§\"ä»Šå¹´â€“æ˜å¹´â€“åå¹´\"è¿™ä¹ˆä¸ªé¡ºåºï¼Œç»™æˆ‘åˆ—ä¸ªå¤§æ¦‚å®‰æ’ï¼Ÿä¸ç”¨å¤ªå¤æ‚ï¼Œæˆ‘å°±æƒ³çŸ¥é“æ¯å¹´é‡ç‚¹å¹²å•¥ã€‚"
    },
    {
        "round": 13,
        "title": "åŠ ä¸€ç‚¹å“ç‰Œ/é”€å”®æ€è·¯",
        "user_input": "å¦‚æœå°†æ¥æˆ‘æƒ³æŠŠå¤§ç±³å’Œç‰›è‚‰æ‰“ä¸ªå°å“ç‰Œ,æ¯”å¦‚\"ä¸œåŒ—æŸæŸå®¶åº­å†œåœº\",ä½ è§‰å¾—åœ¨äº§å“å“è´¨å’Œæ—¥å¸¸ç®¡ç†ä¸Š,æœ‰å“ªäº›ç‚¹æ˜¯æˆ‘ç°åœ¨å°±å¾—åšæŒåšçš„?ä½ é‡ç‚¹ç»™æˆ‘è¯´ä¸‰äº”æ¡å°±è¡Œã€‚"
    },
    {
        "round": 14,
        "title": "æ”¶å°¾",
        "user_input": "å¥½,æ˜ç™½äº†,ä»Šå¤©ä½ è¯´çš„è¿™äº›æˆ‘æ„Ÿè§‰æŒºæœ‰æ–¹å‘çš„ã€‚æˆ‘åé¢å°±æŒ‰è¿™å¥—è·¯å­,æ…¢æ…¢æŠŠå†œåœºå¾€è§„èŒƒåŒ–ã€è§„æ¨¡åŒ–è¿™å—è°ƒæ•´ã€‚è°¢è°¢ï¼"
    }
]


class ConversationLogger:
    """å¯¹è¯æ—¥å¿—è®°å½•å™¨"""
    
    def __init__(self):
        self.log_content = []
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.log_file = project_root / f"conversation_log_{timestamp}.txt"
    
    def add_round(self, round_num: int, title: str, user_input: str, agent_response: str):
        """æ·»åŠ ä¸€è½®å¯¹è¯åˆ°æ—¥å¿—"""
        separator = "=" * 80
        content = f"\n{separator}\n"
        content += f"ç¬¬ {round_num} è½®ï¼š{title}\n"
        content += f"{separator}\n\n"
        content += f"ç”¨æˆ·> {user_input}\n\n"
        content += f"åŠ©æ‰‹> {agent_response}\n"
        self.log_content.append(content)
    
    def save(self):
        """ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶"""
        with open(self.log_file, 'w', encoding='utf-8') as f:
            f.write("=" * 80 + "\n")
            f.write("å¤šè½®å¯¹è¯æµ‹è¯•æ—¥å¿—\n")
            f.write(f"æµ‹è¯•æ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("=" * 80 + "\n")
            f.writelines(self.log_content)
            f.write("\n" + "=" * 80 + "\n")
            f.write("å¯¹è¯ç»“æŸ\n")
            f.write("=" * 80 + "\n")
        print(f"\nğŸ“ å¯¹è¯æ—¥å¿—å·²ä¿å­˜åˆ°: {self.log_file}")


def run_conversation():
    """è¿è¡Œå¤šè½®å¯¹è¯æµ‹è¯•"""
    # ä½¿ç”¨å›ºå®šçš„ thread_id ä¿æŒä¼šè¯è¿ç»­æ€§
    config = {"configurable": {"thread_id": "multi_round_test_001"}}
    logger = ConversationLogger()
    
    print("=" * 80)
    print("å¼€å§‹å¤šè½®å¯¹è¯è‡ªåŠ¨åŒ–æµ‹è¯•")
    print(f"æ€»å…± {len(CONVERSATION_ROUNDS)} è½®å¯¹è¯")
    print("=" * 80)
    print()
    
    for conversation in CONVERSATION_ROUNDS:
        round_num = conversation["round"]
        title = conversation["title"]
        user_input = conversation["user_input"]
        
        print(f"\n{'=' * 80}")
        print(f"ç¬¬ {round_num} è½®ï¼š{title}")
        print(f"{'=' * 80}")
        print(f"ç”¨æˆ·> {user_input}")
        print(f"\nåŠ©æ‰‹> ", end="", flush=True)
        
        agent_response = ""
        
        try:
            # è°ƒç”¨ agent å¹¶æµå¼è¾“å‡º
            for chunk, metadata in image_detection_agent.stream(
                {"messages": [HumanMessage(content=user_input)]},
                config,
                stream_mode="messages",
            ):
                # åªè¾“å‡º AI æ¶ˆæ¯å†…å®¹
                if isinstance(chunk, AIMessageChunk) and chunk.content:
                    print(chunk.content, end="", flush=True)
                    agent_response += chunk.content
            
            print("\n")
            
            # è®°å½•è¿™è½®å¯¹è¯
            logger.add_round(round_num, title, user_input, agent_response)
            
            # æ¯è½®å¯¹è¯åç¨ä½œåœé¡¿ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
            if round_num < len(CONVERSATION_ROUNDS):
                wait_time = 2
                print(f"â±ï¸  ç­‰å¾… {wait_time} ç§’åç»§ç»­ä¸‹ä¸€è½®å¯¹è¯...\n")
                time.sleep(wait_time)
                
        except Exception as e:
            error_msg = f"é”™è¯¯: {str(e)}"
            print(f"\nâŒ {error_msg}\n")
            logger.add_round(round_num, title, user_input, f"[å‘ç”Ÿé”™è¯¯] {error_msg}")
            continue
    
    print("\n" + "=" * 80)
    print("âœ“ æ‰€æœ‰å¯¹è¯è½®æ¬¡å®Œæˆï¼")
    print("=" * 80)
    
    # ä¿å­˜æ—¥å¿—
    logger.save()
    
    print("\nğŸ“Š æµ‹è¯•æ€»ç»“:")
    print(f"   - æ€»è½®æ¬¡: {len(CONVERSATION_ROUNDS)}")
    print("   - æµ‹è¯•åœºæ™¯: ä»åŸºç¡€åŠŸèƒ½äº†è§£åˆ°å†œåœºå‘å±•è§„åˆ’çš„å®Œæ•´å¯¹è¯æµç¨‹")
    print("   - æ¶‰åŠåŠŸèƒ½: å¤§ç±³è¯†åˆ«ã€å®³è™«è¯†åˆ«ã€ç‰›åªæ£€æµ‹ã€ç»¼åˆå’¨è¯¢")


def main():
    """ä¸»å‡½æ•°"""
    try:
        run_conversation()
    except KeyboardInterrupt:
        print("\n\næµ‹è¯•è¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\n\næµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
