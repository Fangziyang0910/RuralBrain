# RuralBrain Docker Compose 配置
# 包含前端、后端主服务以及所有检测算法服务

services:
  # 前端服务 (Next.js)
  frontend:
    build:
      context: ./frontend/my-app
      dockerfile: Dockerfile
    container_name: ruralbrain-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ruralbrain-network

  # 后端主服务 (FastAPI + Agents)
  backend:
    build:
      context: .
      dockerfile: deploy/dev/Dockerfile.backend
    container_name: ruralbrain-backend
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=production
      - PLANNING_SERVICE_URL=http://planning-service:8003
    volumes:
      - ./uploads:/app/uploads
      - ./pest_results:/app/pest_results
      - ./cow_results:/app/cow_results
      - ./rice_results:/app/rice_results
    depends_on:
      - triple-detector
      - planning-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - ruralbrain-network

  # 三合一检测服务（替代原来的三个独立服务）
  triple-detector:
    build:
      context: .
      dockerfile: src/algorithms/triple_detector/Dockerfile
    container_name: triple-detector
    ports:
      - "8001:8001"  # 病虫害检测
      - "8081:8081"  # 大米检测
      - "8002:8002"  # 牛只检测
    environment:
      - ENVIRONMENT=production
    volumes:
      - ./src/algorithms/pest_detection/detector/models:/app/pest/detector/models:ro
      - ./src/algorithms/rice_detection/detector/models:/app/rice/detector/models:ro
      - ./src/algorithms/cow_detection/detector/models:/app/cow/detector/models:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health && curl -f http://localhost:8081/health && curl -f http://localhost:8002/health"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 90s
    networks:
      - ruralbrain-network
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # 规划咨询服务 (Planning Service)
  planning-service:
    build:
      context: .
      dockerfile: src/rag/Dockerfile.service
    container_name: planning-service
    ports:
      - "8003:8003"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=production
      - SERVICE_PORT=8003
      - SERVICE_HOST=0.0.0.0
      - MODEL_PROVIDER=${MODEL_PROVIDER:-deepseek}
    volumes:
      - ./knowledge_base:/app/knowledge_base:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - ruralbrain-network

networks:
  ruralbrain-network:
    driver: bridge
    name: ruralbrain-network
