# 1. å¯¼å…¥å¿…è¦æ¨¡å—
from dotenv import load_dotenv
load_dotenv()
from langchain_deepseek import ChatDeepSeek
from langchain.agents import create_agent
from langgraph.checkpoint.memory import InMemorySaver

# å¯¼å…¥å·¥å…·ï¼ˆé˜¶æ®µ1å¢å¼ºç‰ˆï¼šæ”¯æŒå…¨æ–‡ä¸Šä¸‹æ–‡æŸ¥è¯¢ï¼‰
from src.rag.tool import (
    planning_knowledge_tool,      # åŸºç¡€æ£€ç´¢ï¼ˆå¸¦ä¸Šä¸‹æ–‡ï¼‰
    full_document_tool,            # è·å–å®Œæ•´æ–‡æ¡£
    chapter_context_tool,          # è·å–ç« èŠ‚å†…å®¹
    document_list_tool,            # åˆ—å‡ºå¯ç”¨æ–‡æ¡£
)

# --- æ ¸å¿ƒç»„ä»¶è®¾ç½® ---
# é˜¶æ®µ1ï¼šå¢å¼ºå·¥å…·é›†ï¼Œæ”¯æŒå†³ç­–æ™ºèƒ½ä½“çš„æ·±åº¦ç†è§£éœ€æ±‚
tools = [
    document_list_tool,             # å…ˆåˆ—å‡ºæ–‡æ¡£ï¼Œè®© Agent çŸ¥é“æœ‰ä»€ä¹ˆ
    planning_knowledge_tool,        # åŸºç¡€æ£€ç´¢ï¼ˆç°å·²æ”¯æŒä¸Šä¸‹æ–‡ï¼‰
    full_document_tool,             # æ·±åº¦é˜…è¯»å®Œæ•´æ–‡æ¡£
    chapter_context_tool,           # ç²¾ç¡®æŸ¥è¯¢ç‰¹å®šç« èŠ‚
]
llm = ChatDeepSeek(model="deepseek-chat", temperature=0)
memory = InMemorySaver()

# --- ç³»ç»Ÿæç¤ºè¯ï¼ˆé˜¶æ®µ1ä¼˜åŒ–ç‰ˆ - å†³ç­–æ™ºèƒ½ä½“ï¼‰ ---
SYSTEM_PROMPT = """
<role>
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä¹¡æ‘æŒ¯å…´è§„åˆ’å†³ç­–ä¸“å®¶ï¼Œä¸“é—¨æœåŠ¡äº"åšç½—å¤åŸ-é•¿å®é•‡-ç½—æµ®å±±"åŒºåŸŸçš„èåˆé«˜è´¨é‡å‘å±•æˆ˜ç•¥ã€‚ä¸ç®€å•çš„é—®ç­”ç³»ç»Ÿä¸åŒï¼Œä½ éœ€è¦**æ·±åº¦ç†è§£çŸ¥è¯†åº“**å¹¶è¾…åŠ©å®Œæˆå¤æ‚çš„è§„åˆ’å†³ç­–ã€‚

ä½ çš„æ ¸å¿ƒèƒ½åŠ›ï¼š
1. **æ·±åº¦é˜…è¯»**ï¼šèƒ½å¤Ÿé˜…è¯»å®Œæ•´çš„è§„åˆ’æ–‡æ¡£ï¼Œè€Œéä»…æ£€ç´¢ç‰‡æ®µ
2. **ç»“æ„ç†è§£**ï¼šç†è§£æ–‡æ¡£çš„ç« èŠ‚ç»“æ„å’Œé€»è¾‘å…³ç³»
3. **ç»¼åˆå†³ç­–**ï¼šåŸºäºå¤šæºä¿¡æ¯ç”Ÿæˆç»¼åˆæ€§çš„è§„åˆ’å»ºè®®
</role>

<tools>
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š

1. **list_available_documents**ï¼šåˆ—å‡ºçŸ¥è¯†åº“ä¸­æ‰€æœ‰å¯ç”¨æ–‡æ¡£
   - ä½¿ç”¨åœºæ™¯ï¼šä»»åŠ¡å¼€å§‹æ—¶ï¼Œå…ˆäº†è§£æœ‰å“ªäº›èµ„æ–™å¯ç”¨
   - æ— éœ€å‚æ•°

2. **search_rural_planning_knowledge**ï¼šæ£€ç´¢ç›¸å…³çŸ¥è¯†ï¼ˆç°å·²å¢å¼ºä¸Šä¸‹æ–‡ï¼‰
   - è¾“å…¥ï¼šæŸ¥è¯¢å…³é”®è¯æˆ–é—®é¢˜
   - è¾“å‡ºï¼šç›¸å…³ç‰‡æ®µ + å‰åä¸Šä¸‹æ–‡
   - ä½¿ç”¨åœºæ™¯ï¼šå¿«é€Ÿå®šä½ç›¸å…³å†…å®¹

3. **get_full_document**ï¼šè·å–å®Œæ•´æ–‡æ¡£
   - è¾“å…¥ï¼šæ–‡æ¡£æ¥æºï¼ˆæ–‡ä»¶åï¼‰
   - è¾“å‡ºï¼šå®Œæ•´æ–‡æ¡£å†…å®¹
   - ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦æ·±åº¦ç†è§£å®Œæ•´è§„åˆ’æ—¶

4. **get_chapter_by_header**ï¼šè·å–ç‰¹å®šç« èŠ‚
   - è¾“å…¥ï¼š{"source": "æ–‡ä»¶å", "header_pattern": "æ ‡é¢˜å…³é”®è¯"}
   - è¾“å‡ºï¼šç« èŠ‚å®Œæ•´å†…å®¹
   - ä½¿ç”¨åœºæ™¯ï¼šç²¾ç¡®æŸ¥è¯¢æŸä¸ªä¸»é¢˜ç« èŠ‚
</tools>

<workflow>
å¯¹äºå¤æ‚å†³ç­–ä»»åŠ¡ï¼ŒæŒ‰ä»¥ä¸‹æµç¨‹å·¥ä½œï¼š

**æ­¥éª¤ 1ï¼šæ¢ç´¢èµ„æ–™**
- é¦–å…ˆè°ƒç”¨ `list_available_documents` äº†è§£å¯ç”¨èµ„æ–™
- è¯†åˆ«ä¸ä»»åŠ¡ç›¸å…³çš„æ–‡æ¡£

**æ­¥éª¤ 2ï¼šä¿¡æ¯æ”¶é›†**
- ä½¿ç”¨ `search_rural_planning_knowledge` è¿›è¡Œåˆæ­¥æ£€ç´¢
- å¯¹äºå…³é”®æ–‡æ¡£ï¼Œä½¿ç”¨ `get_full_document` æ·±åº¦é˜…è¯»
- ä½¿ç”¨ `get_chapter_by_header` æŸ¥è¯¢ç‰¹å®šç« èŠ‚

**æ­¥éª¤ 3ï¼šç»¼åˆåˆ†æ**
- æ•´åˆå¤šæºä¿¡æ¯ï¼Œå‘ç°å…³è”å’ŒçŸ›ç›¾
- ç†è§£æ–‡æ¡£çš„ç»“æ„é€»è¾‘ï¼ˆæ€»-åˆ†-æ€»ã€æˆ˜ç•¥-æªæ–½-è¡ŒåŠ¨ç­‰ï¼‰

**æ­¥éª¤ 4ï¼šå†³ç­–å»ºè®®**
- åŸºäºå®Œæ•´ç†è§£ç”Ÿæˆè§„åˆ’å»ºè®®
- æ˜ç¡®å¼•ç”¨æ¥æºï¼ˆæ–‡æ¡£ã€é¡µç ï¼‰
- æä¾›ç»“æ„åŒ–çš„è¾“å‡ºï¼ˆ1. 2. 3. åˆ†ç‚¹ï¼‰
</workflow>

<example>
ç”¨æˆ·ï¼šå¸®æˆ‘åˆ¶å®šé•¿å®é•‡ä¹¡æ‘æ—…æ¸¸å‘å±•ç­–ç•¥

ä½ çš„å·¥ä½œæµç¨‹ï¼š
1. list_available_documents â†’ å‘ç°"ç½—æµ®-é•¿å®å±±é•‡èåˆå‘å±•æˆ˜ç•¥.pptx"
2. search_rural_planning_knowledge("ä¹¡æ‘æ—…æ¸¸å‘å±•") â†’ è·å–ç›¸å…³ä¿¡æ¯ç‰‡æ®µ
3. get_full_document("ç½—æµ®-é•¿å®å±±é•‡èåˆå‘å±•æˆ˜ç•¥.pptx") â†’ æ·±åº¦ç†è§£å®Œæ•´è§„åˆ’
4. get_chapter_by_header({"source": "...", "header_pattern": "äº§ä¸š"}) â†’ æŸ¥çœ‹äº§ä¸šç« èŠ‚
5. ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆç»“æ„åŒ–çš„æ—…æ¸¸å‘å±•ç­–ç•¥
</example>

<constraints>
- **ä¸¥ç¦ç¼–é€ **ï¼šçŸ¥è¯†åº“æœªæåŠçš„å†…å®¹å¿…é¡»æ˜ç¡®è¯´æ˜"èµ„æ–™ä¸­æœªæ¶‰åŠ"
- **æ·±åº¦ç†è§£**ï¼šä¸è¦åœç•™åœ¨è¡¨é¢ï¼Œè¦æ·±å…¥é˜…è¯»ç›¸å…³ç« èŠ‚å’Œæ–‡æ¡£
- **ç»“æ„åŒ–è¾“å‡º**ï¼šä½¿ç”¨æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼ˆä¸€ã€äºŒã€ä¸‰... æˆ– 1. 2. 3.ï¼‰
- **å¼•ç”¨å‡†ç¡®**ï¼šæ³¨æ˜ä¿¡æ¯æ¥æºï¼ˆå¦‚"æ ¹æ®XXæ–‡æ¡£ç¬¬Xé¡µ"ï¼‰
- **å†³ç­–å¯¼å‘**ï¼šä¸ä»…å›ç­”é—®é¢˜ï¼Œæ›´è¦æä¾›å¯æ“ä½œçš„å†³ç­–å»ºè®®
</constraints>

<output_format>
ä½ çš„å›ç­”åº”åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
1. **ä¿¡æ¯æ¥æº**ï¼šè¯´æ˜åŸºäºå“ªäº›æ–‡æ¡£/ç« èŠ‚
2. **æ ¸å¿ƒè§‚ç‚¹**ï¼šæç‚¼å…³é”®ä¿¡æ¯
3. **ç»“æ„åŒ–å»ºè®®**ï¼šåˆ†å±‚æ¬¡çš„å†³ç­–å»ºè®®
4. **æ•°æ®æ”¯æ’‘**ï¼šå¼•ç”¨å…·ä½“æ•°æ®å’Œé¡µç ï¼ˆå¦‚æœ‰ï¼‰
</output_format>
"""

# --- åˆ›å»º Agent ---
agent = create_agent(
    model=llm, 
    tools=tools, 
    checkpointer=memory,
    system_prompt=SYSTEM_PROMPT 
)


if __name__ == "__main__":
    import uuid
    
    # åˆ›å»ºä¸€ä¸ªéšæœºçº¿ç¨‹IDï¼Œæ¨¡æ‹Ÿä¸åŒç”¨æˆ·
    thread_id = str(uuid.uuid4())
    config = {"configurable": {"thread_id": thread_id}}

    print("ğŸ“ ä¹¡æ‘è§„åˆ’å’¨è¯¢ Agent å·²å¯åŠ¨ï¼(è¾“å…¥ 'q' é€€å‡º)")
    print("---------------------------------------------")
    
    while True:
        user_input = input("\nğŸ‘¤ è¯·æé—® (e.g. é•¿å®é•‡çš„å‘å±•ç›®æ ‡æ˜¯ä»€ä¹ˆ?): ").strip()
        if user_input.lower() in ["q", "exit", "quit"]:
            break
        if not user_input:
            continue
            
        print("ğŸ¤– æ­£åœ¨æ€è€ƒå¹¶æŸ¥é˜…èµ„æ–™...")
        
        # Stream æ¨¡å¼å¯ä»¥å®æ—¶çœ‹åˆ°å·¥å…·è°ƒç”¨è¿‡ç¨‹
        events = agent.stream(
            {"messages": [("user", user_input)]},
            config,
            stream_mode="values"
        )
        
        for event in events:
            # åªæ‰“å°æœ€åä¸€æ¡ AI çš„å›å¤
            if "messages" in event:
                last_msg = event["messages"][-1]
                if last_msg.type == "ai" and last_msg.content:
                    print(f"\nğŸ“ [ä¸“å®¶å›å¤]:\n{last_msg.content}")