# ğŸ› å®³è™«æ£€æµ‹API - éƒ¨ç½²ä½¿ç”¨æŒ‡å—

## ğŸ“ é¡¹ç›®ç»“æ„

```
pest_detection/
â”œâ”€â”€ detector/                    # æ ¸å¿ƒæ£€æµ‹æœåŠ¡
â”‚   â”œâ”€â”€ app/                    # åº”ç”¨æ ¸å¿ƒä»£ç 
â”‚   â”‚   â”œâ”€â”€ api/               # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ core/              # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ schemas/           # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ services/          # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ models/                # AIæ¨¡å‹æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ best.pt           # YOLOv8æ¨¡å‹ï¼ˆå¿…éœ€ï¼‰
â”‚   â”‚   â””â”€â”€ classes.txt       # ç±»åˆ«åˆ—è¡¨ï¼ˆå¿…éœ€ï¼‰
â”‚   â”œâ”€â”€ Dockerfile            # Dockeré•œåƒé…ç½®
â”‚   â”œâ”€â”€ docker-compose.yml    # å®¹å™¨ç¼–æ’é…ç½®
â”‚   â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–
â”‚   â”œâ”€â”€ run.py               # åŸå§‹å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ start_service.py     # æ ‡å‡†å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test/                      # æµ‹è¯•æ–‡ä»¶
â””â”€â”€ README.md                  # æ¨¡å—è¯´æ˜
```

---

## ğŸš€ æ–¹å¼ä¸€ï¼šDockeréƒ¨ç½²ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

### å‰ç½®è¦æ±‚
- **Docker Desktop** å·²å®‰è£…å¹¶å¯åŠ¨
- è‡³å°‘ 4GB å¯ç”¨å†…å­˜
- ç¡®ä¿ 8001 ç«¯å£æœªè¢«å ç”¨

### 1. å®‰è£…Docker Desktopï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
1. è®¿é—® https://www.docker.com/products/docker-desktop
2. ä¸‹è½½å¹¶å®‰è£… Docker Desktop for Windows
3. å¯åŠ¨ Docker Desktop
4. ç¡®ä¿ Docker æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤º Docker å›¾æ ‡ï¼‰

### 2. éƒ¨ç½²æœåŠ¡

**æ–¹å¼ä¸€ï¼šä½¿ç”¨ PowerShell**
```powershell
# è¿›å…¥ detector ç›®å½•
cd "D:\sourse code\RuralBrain\src\algorithms\pest_detection\detector"

# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker-compose up -d --build
```

**æ–¹å¼äºŒï¼šä½¿ç”¨ CMD**
```cmd
cd /d "D:\sourse code\RuralBrain\src\algorithms\pest_detection\detector"
docker-compose up -d --build
```

### 3. è®¿é—®æœåŠ¡
- **APIæ–‡æ¡£**: http://localhost:8001/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:8001/health
- **ä¸»é¡µ**: http://localhost:8001

### 4. ç®¡ç†æœåŠ¡

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose stop

# é‡å¯æœåŠ¡
docker-compose restart

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down
```

---

## ğŸ’» æ–¹å¼äºŒï¼šPythonç›´æ¥è¿è¡Œï¼ˆæ¨èç”¨äºå¼€å‘ç¯å¢ƒï¼‰

## ğŸ’» æ–¹å¼äºŒï¼šPythonç›´æ¥è¿è¡Œï¼ˆæ¨èç”¨äºå¼€å‘ç¯å¢ƒï¼‰

### å‰ç½®è¦æ±‚
- Python 3.8-3.13 å·²å®‰è£…
- å·²å®Œæˆé¡¹ç›®ä¾èµ–å®‰è£…

### 1. å®‰è£…ä¾èµ–

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd "D:\sourse code\RuralBrain"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
.venv\Scripts\activate

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æœªå®‰è£…ï¼‰
uv pip install -e .
```

### 2. å¯åŠ¨æœåŠ¡

**æ–¹å¼ä¸€ï¼šä½¿ç”¨æ ‡å‡†å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰**
```bash
python -m src.algorithms.pest_detection.detector.start_service
```

**æ–¹å¼äºŒï¼šç›´æ¥è¿è¡Œ**
```bash
cd src\algorithms\pest_detection\detector
python start_service.py
```

**æ–¹å¼ä¸‰ï¼šä½¿ç”¨åŸå§‹è„šæœ¬**
```bash
cd src\algorithms\pest_detection\detector
python run.py
```

### 3. è®¿é—®æœåŠ¡
- **APIæ–‡æ¡£**: http://localhost:8001/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:8001/health

### 4. åœæ­¢æœåŠ¡
åœ¨è¿è¡ŒæœåŠ¡çš„å‘½ä»¤è¡Œçª—å£ä¸­æŒ‰ `Ctrl + C`

---

## ğŸ§ª APIä½¿ç”¨ç¤ºä¾‹

### 1. å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8001/health
```

### 2. æ£€æµ‹å®³è™«ï¼ˆä½¿ç”¨ base64 å›¾åƒï¼‰
```bash
curl -X POST "http://localhost:8001/detect" \
     -H "Content-Type: application/json" \
     -d '{"image_base64": "ä½ çš„base64å›¾åƒæ•°æ®"}'
```

### 3. Pythonæµ‹è¯•ç¤ºä¾‹
```python
import requests
import base64

# å¥åº·æ£€æŸ¥
response = requests.get("http://localhost:8001/health")
print(response.json())

# æ£€æµ‹å®³è™«
with open("test_image.jpg", "rb") as f:
    img_b64 = base64.b64encode(f.read()).decode()

response = requests.post(
    "http://localhost:8001/detect",
    json={"image_base64": img_b64}
)

result = response.json()
if result["success"]:
    print(f"æ£€æµ‹åˆ° {len(result['detections'])} ç§å®³è™«:")
    for det in result["detections"]:
        print(f"  - {det['name']}: {det['count']}åª")
```

### 4. ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
cd src\algorithms\pest_detection\test
python test.py
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### ä¿®æ”¹ç«¯å£

**Dockeræ–¹å¼**ï¼šç¼–è¾‘ `detector/docker-compose.yml`
```yaml
services:
  insect-detector:
    ports:
      - "8002:8001"  # æ”¹ä¸ºå…¶ä»–ç«¯å£
```

**Pythonæ–¹å¼**ï¼šç¼–è¾‘ `detector/app/core/config.py`
```python
PORT: int = 8002  # æ”¹ä¸ºå…¶ä»–ç«¯å£
```

### ç¯å¢ƒå˜é‡

å¯ä»¥åˆ›å»º `.env` æ–‡ä»¶é…ç½®ï¼š
```env
HOST=0.0.0.0
PORT=8001
LOG_LEVEL=INFO
```

---

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### Dockeréƒ¨ç½²é—®é¢˜

**1. DockeræœåŠ¡æœªå¯åŠ¨**
```bash
# ç¡®è®¤Docker Desktopæ­£åœ¨è¿è¡Œ
# æŸ¥çœ‹ç³»ç»Ÿæ‰˜ç›˜æ˜¯å¦æœ‰Dockerå›¾æ ‡
```

**2. ç«¯å£è¢«å ç”¨**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :8001

# ä¿®æ”¹ docker-compose.yml ä½¿ç”¨å…¶ä»–ç«¯å£
```

**3. æ„å»ºå¤±è´¥æˆ–ç½‘ç»œè¶…æ—¶**
```bash
# æ¸…ç†Dockerç¼“å­˜åé‡è¯•
docker system prune -a

# ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆå·²åœ¨Dockerfileä¸­é…ç½®ï¼‰
```

**4. æ¨¡å‹æ–‡ä»¶ç¼ºå¤±**
```bash
# ç¡®ä¿æ¨¡å‹æ–‡ä»¶å­˜åœ¨
dir detector\models\best.pt
dir detector\models\classes.txt
```

### Pythonéƒ¨ç½²é—®é¢˜

**1. æ¨¡å—å¯¼å…¥é”™è¯¯**
```bash
# ç¡®ä¿ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
cd "D:\sourse code\RuralBrain"

# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
.venv\Scripts\activate

# ä½¿ç”¨æ­£ç¡®çš„å¯åŠ¨æ–¹å¼
python -m src.algorithms.pest_detection.detector.start_service
```

**2. ä¾èµ–ç¼ºå¤±**
```bash
# å®‰è£…ç¼ºå¤±çš„ä¾èµ–
uv pip install fastapi uvicorn pydantic-settings python-multipart
```

**3. ç«¯å£è¢«å ç”¨**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :8001

# æˆ–ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£
```

**4. æ¨¡å‹åŠ è½½å¤±è´¥**
- ç¡®ä¿ `detector/models/best.pt` æ–‡ä»¶å­˜åœ¨ä¸”å®Œæ•´
- æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦æ­£å¸¸ï¼ˆçº¦ 6MBï¼‰

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### Dockeréƒ¨ç½²
- [ ] Docker Desktop å·²å®‰è£…å¹¶å¯åŠ¨
- [ ] è¿›å…¥ `detector` ç›®å½•
- [ ] æ¨¡å‹æ–‡ä»¶å­˜åœ¨ï¼ˆ`models/best.pt` å’Œ `models/classes.txt`ï¼‰
- [ ] æ‰§è¡Œ `docker-compose up -d --build`
- [ ] è®¿é—® http://localhost:8001/docs æ­£å¸¸
- [ ] APIå¥åº·æ£€æŸ¥é€šè¿‡

### Pythonéƒ¨ç½²
- [ ] Python 3.8+ å·²å®‰è£…
- [ ] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»ºå¹¶æ¿€æ´»
- [ ] ä¾èµ–å·²å®‰è£…ï¼ˆ`uv pip install -e .`ï¼‰
- [ ] æ¨¡å‹æ–‡ä»¶å­˜åœ¨
- [ ] å¯åŠ¨æœåŠ¡æˆåŠŸ
- [ ] è®¿é—® http://localhost:8001/docs æ­£å¸¸
- [ ] APIå¥åº·æ£€æŸ¥é€šè¿‡

---

## ğŸ› æ”¯æŒçš„å®³è™«ç±»å‹ï¼ˆ29ç§ï¼‰

ç“œå®è‡ã€å°èœè›¾ã€æ–‘æ½œè‡ã€ä¾§å¤šé£Ÿè·—çº¿è¨ã€ç¨»ç²‰è™±ã€è”æè’‚è›€è™«ã€è”æè½ã€è”æç˜¿è¨ã€ç”˜è”—èŸè™«ã€èŒ¶å°ç»¿å¶è‰ã€ç¦å¯¿èºã€å°è±¡ç”²ã€çƒŸç²‰è™±ã€ç¨»çºµå·å¶èŸã€å¤§èŸã€äºŒåŒ–èŸã€ç¨»é£è™±ã€ç‰ç±³èŸã€è‰åœ°è´ªå¤œè›¾ã€èšœè™«ã€é»„æ›²æ¡è·³ç”²ã€ç”œèœå¤œè›¾ã€è”¬èœè“Ÿé©¬ã€èœé’è™«ã€æŸ‘æ¡”çº¢èœ˜è››ã€æŸ‘æ¡”é”ˆèœ˜è››ã€æ¡”å°å®è‡ã€æ–œçº¹å¤œè›¾ã€æŸ‘æ¡”æ½œå¶è›¾

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **æ¨¡å‹åŠ è½½æ—¶é—´**: 1-3ç§’
- **å•å›¾æ£€æµ‹æ—¶é—´**: 1-3ç§’
- **å†…å­˜å ç”¨**: 200-500MB
- **æ£€æµ‹å‡†ç¡®ç‡**: 95%+
- **å¹¶å‘æ”¯æŒ**: æ ¹æ®ç¡¬ä»¶é…ç½®

---

## ğŸ’¡ å¿«é€ŸéªŒè¯

è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼š

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
cd "D:\sourse code\RuralBrain"
python src\algorithms\pest_detection\verify_setup.py
```

æ‰€æœ‰æµ‹è¯•é€šè¿‡åå³å¯æ­£å¸¸ä½¿ç”¨æœåŠ¡ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [detector/README_zh.md](detector/README_zh.md) - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
- [detector/DOCKER_DEPLOY.md](detector/DOCKER_DEPLOY.md) - Dockeréƒ¨ç½²è¯¦ç»†è¯´æ˜
- [REFACTORING_SUMMARY.md](REFACTORING_SUMMARY.md) - é‡æ„è¯´æ˜
- [README.md](README.md) - æ¨¡å—æ€»è§ˆ

---

*æœ€åæ›´æ–°: 2025-12-03 | ç‰ˆæœ¬: 1.0.0*