# RAG 模块服务化、部署化规划文档

> **文档状态**: 规划中
> **创建时间**: 2026-01-16
> **目标**: 将RAG模块建设为独立、可扩展、生产就绪的微服务

---

## 目录

1. [当前状况分析](#一当前状况分析)
2. [技术架构设计](#二技术架构设计)
3. [服务化实施方案](#三服务化实施方案)
4. [部署化配置](#四部署化配置)
5. [与其他Agent集成](#五与其他agent集成)
6. [前端集成方案](#六前端集成方案)
7. [实施路线图](#七实施路线图)
8. [后续迭代计划](#八后续迭代计划)

---

## 一、当前状况分析

### 1.1 已实现功能

#### 核心RAG能力
当前RAG模块位于 `src/rag/` 目录，包含以下核心组件：

- **core/tools.py**: 9个LangChain工具（快速检索、深度查询、摘要生成）
- **core/context_manager.py**: 文档上下文管理
- **core/summarization.py**: 层次化摘要生成
- **build.py**: 知识库构建脚本
- **config.py**: 配置管理（支持环境变量）
- **utils/loaders.py**: 文档加载器（支持.docx, .pdf, .pptx, .txt, .md）

#### Planning Agent集成状态
- **文件位置**: `src/agents/planning_agent.py`
- **集成工具**: 9个工具（快速模式4个 + 深度模式5个）
- **工作模式**:
  - **快速模式**: 执行摘要 → 章节摘要 → 要点搜索
  - **深度模式**: 全文检索 → 完整章节 → 完整文档
- **测试覆盖**: 单元测试和集成测试已就绪

#### 知识库现状
- **存储位置**: `knowledge_base/chroma_db/`
- **文档内容**: 博罗古城规划、罗浮山发展战略等
- **向量模型**: BAAI/bge-small-zh-v1.5
- **切片大小**: 2500字符（针对Planning Agent优化）

### 1.2 缺失的部署化功能

| 功能 | 状态 | 说明 |
|------|------|------|
| FastAPI服务 | ❌ 缺失 | 没有main.py或app.py |
| API路由 | ❌ 缺失 | 无HTTP端点 |
| 独立端口 | ❌ 缺失 | Dockerfile暴露8000但无实际服务 |
| 健康检查 | ❌ 缺失 | 无/health端点 |
| Docker编排 | ❌ 缺失 | 未加入docker-compose.yml |
| 主服务集成 | ❌ 缺失 | service/server.py未接入 |
| 前端对接 | ❌ 缺失 | 无法通过Web访问 |

### 1.3 现有Docker配置问题

当前 `src/rag/Dockerfile` 存在以下问题：
- CMD命令用于构建知识库，而非运行服务
- 暴露端口8000但没有实际服务监听
- 缺少启动脚本或进程管理

**结论**: 现有Dockerfile仅适用于知识库构建，不适合作为服务部署。

---

## 二、技术架构设计

### 2.1 目标架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Frontend (Next.js)                      │
│                      Port: 3000                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 图像检测聊天  │  │ 规划咨询聊天  │  │  综合对话    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────┬─────────────────┬──────────────────┬───────────────┘
         │                 │                  │
         ▼                 ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                  Backend API Gateway (8080)                 │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐   │
│  │ /chat/detection│  │ /chat/planning │  │  /chat/general│   │
│  └────────────────┘  └────────────────┘  └──────────────┘   │
└────────┬─────────────────┬──────────────────┬───────────────┘
         │                 │                  │
         ▼                 ▼                  │
┌──────────────┐  ┌──────────────┐           │
│ Image Agent  │  │Planning Agent│           │
│  (内部)      │  │  (内部)      │           │
└──────────────┘  └──────┬───────┘           │
                         │                   │
                    HTTP调用                  │
                         │                   │
                         ▼                   ▼
              ┌──────────────────────────────────────┐
              │      Planning Service (8003)         │
              │  ┌─────────────────────────────────┐ │
              │  │  FastAPI + LangChain Agent      │ │
              │  │  ┌─────────┐  ┌─────────────┐  │ │
              │  │  │RAG Tools│  │Context Mgr  │  │ │
              │  │  └─────────┘  └─────────────┘  │ │
              │  └─────────────────────────────────┘ │
              └──────────────┬───────────────────────┘
                             │
                         读取
                             │
                             ▼
              ┌───────────────────────────────────────┐
              │    Knowledge Base (ChromaDB)          │
              │    Path: /app/knowledge_base          │
              └───────────────────────────────────────┘
```

### 2.2 服务职责划分

| 服务 | 端口 | 职责 | 技术栈 |
|------|------|------|--------|
| **Planning Service** | 8003 | 乡村规划咨询、知识检索、文档摘要 | FastAPI + LangChain + ChromaDB |
| **Image Detection Service** | 8080 | 图像检测Agent（已存在） | FastAPI + LangChain |
| **Pest Detector** | 8001 | 病虫害检测 | FastAPI + YOLO |
| **Rice Detector** | 8081 | 大米品种识别 | FastAPI + YOLO |
| **Cow Detector** | 8002 | 奶牛检测 | FastAPI + YOLO |

### 2.3 网络通信设计

**Docker网络**: ruralbrain-network（bridge模式）

**服务间通信**:
- Frontend → Backend: HTTP（SSE流式响应）
- Backend → Planning Service: HTTP（同步调用）
- Planning Service → ChromaDB: 本地文件访问

---

## 三、服务化实施方案

### 3.1 目录结构设计

```
src/rag/
├── service/                    # 新增：FastAPI服务代码
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── api/
│   │   ├── __init__.py
│   │   └── routes.py           # API路由定义
│   ├── core/
│   │   ├── __init__.py
│   │   └── config.py           # 服务配置（端口、日志等）
│   └── schemas/
│       ├── __init__.py
│       ├── chat.py             # 请求/响应模型
│       └── knowledge.py        # 知识库查询模型
├── core/                       # 已存在：RAG核心逻辑
├── utils/                      # 已存在：工具函数
├── tests/                      # 已存在：测试
├── Dockerfile.service          # 新增：服务Dockerfile
└── docker-compose.service.yml  # 新增：服务编排配置
```

### 3.2 核心API端点设计

#### 端点1: POST /api/v1/chat/planning
**功能**: Planning Agent对话端点
**输入**:
- message: 用户问题
- thread_id: 对话线程ID（可选）
- mode: 工作模式（auto/fast/deep）

**输出**: SSE流式响应
- 响应内容
- 使用的工具列表
- 实际工作模式

#### 端点2: GET /api/v1/knowledge/documents
**功能**: 列出所有可用文档
**输出**: 文档列表（包含类型、切片数、预览）

#### 端点3: GET /api/v1/knowledge/summary/{source}
**功能**: 获取文档执行摘要
**输入**: source（文档文件名）
**输出**: 200字执行摘要

#### 端点4: GET /api/v1/knowledge/chapters/{source}
**功能**: 列出文档章节摘要
**输入**: source（文档文件名）
**输出**: 章节列表及每个章节的摘要

#### 端点5: GET /health
**功能**: 健康检查
**输出**: 服务状态

### 3.3 服务配置项

**端口配置**:
- SERVICE_PORT: 8003（默认）
- SERVICE_HOST: 0.0.0.0

**CORS配置**:
- ALLOWED_ORIGINS: 默认允许所有（生产环境需限制）

**知识库配置**:
- KNOWLEDGE_BASE_PATH: /app/knowledge_base
- VECTOR_DB_TYPE: chroma

**Agent配置**:
- MODEL_PROVIDER: deepseek
- MODEL_TEMPERATURE: 0

---

## 四、部署化配置

### 4.1 Docker配置要点

**Dockerfile.service 应包含**:
- 基础镜像: python:3.13-slim
- 工作目录: /app
- 依赖安装: 使用uv包管理器
- 环境变量: PYTHONUNBUFFERED=1, SERVICE_PORT=8003
- 暴露端口: 8003
- 健康检查: curl -f http://localhost:8003/health
- 启动命令: uvicorn启动FastAPI应用

**docker-compose.service.yml 应包含**:
- 服务名称: planning-service
- 端口映射: 8003:8003
- 卷挂载:
  - knowledge_base（只读）
  - 代码目录（只读）
- 环境变量: 从.env文件读取
- 重启策略: unless-stopped
- 健康检查配置
- 网络连接: ruralbrain-network

### 4.2 集成到主Docker Compose

**修改 docker-compose.yml**:
- 添加planning-service服务定义
- 在backend服务的depends_on中添加planning-service
- 添加knowledge_base卷挂载到backend（用于知识库访问）

### 4.3 环境变量配置

**新增环境变量（.env.example）**:
- PLANNING_SERVICE_PORT=8003
- KNOWLEDGE_BASE_PATH=/app/knowledge_base
- VECTOR_DB_TYPE=chroma
- EMBEDDING_MODEL_NAME=BAAI/bge-small-zh-v1.5
- EMBEDDING_DEVICE=cpu
- DEFAULT_TOP_K=5
- CHUNK_SIZE=2500
- CHUNK_OVERLAP=500

---

## 五、与其他Agent集成

### 5.1 集成策略

**方案**: 统一API网关（通过Backend实现）

Backend作为统一入口，负责：
1. 接收前端所有请求
2. 意图识别（判断用户需求）
3. 路由到相应的Agent或服务
4. 返回统一格式的响应

### 5.2 意图识别逻辑

**规则1: 图像检测**
- 用户上传了图片
- 或使用检测相关关键词（识别、检测、害虫、大米、牛等）

**规则2: 规划咨询**
- 使用规划相关关键词（规划、发展、策略、旅游、产业、博罗、罗浮山、长宁镇、古城、政策、方案等）

**规则3: 通用对话**
- 其他类型的问题

### 5.3 Agent协同工作流

```
用户输入
   │
   ▼
┌──────────────┐
│ 意图识别     │
└──────┬───────┘
       │
   ┌───┴────┬─────────┐
   ▼        ▼         ▼
检测     规划      通用
   │        │         │
   ▼        ▼         ▼
Image   Planning  LLM
Agent   Service   直接
   │        │         │
   └───┬────┴─────────┘
       ▼
  统一响应
```

### 5.4 Backend集成要点

**修改 service/server.py**:
- 添加意图分类函数
- 添加handle_planning_chat处理函数
- 通过HTTP调用Planning Service
- 保持SSE流式响应格式
- 添加超时和错误处理

---

## 六、前端集成方案

### 6.1 页面组件设计

**新增 /planning 页面**:
- 顶部标题和描述
- 模式选择器（三个按钮）
  - 🤖 自动模式（AI根据问题复杂度选择）
  - ⚡ 快速浏览（使用摘要和要点）
  - 🔍 深度分析（阅读完整文档）
- 聊天窗口组件
- 功能特性
  - 文件上传按钮隐藏（不需要图片）
  - 显示知识库搜索结果
  - 显示文档预览功能

### 6.2 主页集成

**修改主页面**:
- 添加模式切换卡片
- "🖼️ 图像检测" - 链接到主页
- "🏘️ 规划咨询" - 链接到/planning页面

### 6.3 API客户端功能

**lib/api/planning.ts 应实现**:
- 流式请求处理（SSE）
- 请求重连机制
- 错误处理
- 进度指示

### 6.4 用户体验优化

**功能特性**:
1. **模式可视化**: 显示当前使用的工作模式
2. **工具调用展示**: 显示Agent调用了哪些工具
3. **文档预览**: 点击可查看完整文档
4. **引用来源**: 标注信息来源文档
5. **响应时间**: 显示响应耗时

---

## 七、实施路线图

### 阶段1：服务基础搭建（2-3天）

**目标**: 创建可运行的Planning Service

**Day 1: API服务框架**
- 创建 src/rag/service/ 目录结构
- 实现main.py（FastAPI应用）
- 实现api/routes.py（3个核心端点）
- 实现schemas/（请求/响应模型）
- 实现core/config.py（服务配置）

**Day 2: Docker配置**
- 创建Dockerfile.service
- 创建docker-compose.service.yml
- 本地测试容器启动
- 验证健康检查端点
- 测试知识库加载

**Day 3: 流式响应实现**
- 实现SSE流式输出
- 集成Planning Agent
- 端到端测试（使用curl）
- 性能基准测试

**交付物**:
- 可独立运行的Planning Service容器
- HTTP API文档（Swagger UI）
- 基础测试用例

---

### 阶段2：集成到主系统（2天）

**目标**: Planning Service可通过主Backend访问

**Day 4: 主Backend集成**
- 修改service/server.py添加意图识别
- 实现/chat/planning代理端点
- 更新docker-compose依赖关系
- 测试服务间通信
- 处理超时和错误

**Day 5: 配置优化**
- 更新.env.example
- 添加服务监控和日志
- 编写部署文档
- 完整集成测试
- 性能测试

**交付物**:
- 主Backend可路由Planning请求
- 完整的docker-compose配置
- 部署文档

---

### 阶段3：前端集成（2-3天）

**目标**: 用户可通过Web界面使用规划咨询

**Day 6: 前端页面开发**
- 创建/planning页面
- 实现模式选择器（自动/快速/深度）
- 实现知识库搜索结果展示
- 实现文档预览组件
- 样式和布局优化

**Day 7: API客户端**
- 实现lib/api/planning.ts
- 实现SSE流式响应处理
- 错误处理和重连逻辑
- 加载状态和进度指示
- 工具调用可视化

**Day 8: 联调测试**
- 端到端测试（完整用户流程）
- UI/UX优化
- 性能测试（响应时间）
- 修复bug
- 用户反馈收集

**交付物**:
- 功能完整的规划咨询页面
- 良好的用户体验
- 测试报告

---

### 阶段4：生产优化（1-2天）

**目标**: 生产环境就绪

**Day 9: 监控和日志**
- 添加结构化日志（JSON格式）
- 集成LangSmith追踪
- 性能指标收集（响应时间、工具调用）
- 错误告警配置
- 日志聚合和查询

**Day 10: 文档和部署**
- API文档完善
- 部署手册
- 运维手册
- 用户使用指南
- 故障排查指南

**交付物**:
- 生产就绪的服务
- 完整的文档体系

---

## 八、后续迭代计划

### 8.1 知识库增强

**优先级: 高**

**文档扩充**:
- 添加更多乡村规划案例
- 添加农业政策文档
- 添加产业数据分析
- 定期更新知识库

**检索优化**:
- 实现混合检索（向量+关键词）
- 添加重排序（Rerank）模型
- 优化切片策略（文档类型自适应）
- 添加查询扩展（同义词、相关词）

**摘要增强**:
- 生成多级摘要（执行摘要 → 章节摘要 → 要点）
- 添加表格数据提取
- 添加图表描述生成
- 实现增量摘要更新

### 8.2 Agent能力增强

**优先级: 中**

**多轮对话优化**:
- 实现上下文记忆增强
- 添加用户偏好学习
- 实现对话历史压缩
- 添加对话状态管理

**工具调用优化**:
- 实现工具调用并行化
- 添加工具调用缓存
- 实现工具调用失败重试
- 添加工具调用性能监控

**响应质量提升**:
- 优化系统提示词
- 添加few-shot示例
- 实现响应质量评分
- 添加用户反馈收集

### 8.3 服务功能增强

**优先级: 低**

**高级功能**:
- 文档对比分析
- 跨文档关联推荐
- 规划方案生成器
- 数据可视化（图表生成）

**用户体验**:
- 保存对话历史
- 导出规划报告
- 分享功能
- 多语言支持

**性能优化**:
- 实现响应缓存
- 优化向量检索速度
- 实现异步任务处理
- 添加负载均衡

---

## 九、技术选型说明

### 为什么选择独立服务架构？

**优点**:
1. 解耦: Planning Service独立开发、部署、扩展
2. 技术栈灵活: 可使用不同Python版本或依赖
3. 独立扩展: 可根据负载单独扩容
4. 故障隔离: 单个服务故障不影响其他功能
5. 团队协作: 不同团队可并行开发

**缺点**:
1. 增加部署复杂度
2. 服务间通信开销
3. 需要服务发现和监控

**结论**: 对于生产环境和长期扩展，独立服务架构是正确选择。

### 为什么选择SSE流式响应？

**优点**:
1. 实时反馈（用户可见Agent思考过程）
2. 更好的用户体验（无需等待完整响应）
3. 降低首字节时间（TTFB）
4. 支持长响应（避免超时）

**缺点**:
1. 实现复杂度高
2. 错误处理更困难

**结论**: 与现有Image Agent保持一致，提供统一体验。

---

## 十、风险评估和缓解

### 风险矩阵

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Planning Agent响应慢 | 高 | 中 | 1. 添加请求超时<br>2. 实现响应缓存<br>3. 优化检索速度 |
| 知识库检索不准 | 高 | 中 | 1. 优化切片策略<br>2. 添加混合检索<br>3. 收集用户反馈 |
| 服务依赖复杂 | 中 | 低 | 1. 清晰的文档<br>2. 健康检查<br>3. 降级方案 |
| Docker镜像过大 | 低 | 高 | 1. 多阶段构建<br>2. 分离依赖<br>3. 使用.slim镜像 |

### 降级方案

**如果Planning Service不可用**:
- 主Backend返回503错误
- 提示用户"规划服务暂时不可用，请稍后重试"
- 记录错误日志和监控告警
- 自动重试机制

---

## 十一、测试策略

### 单元测试
- 测试各个API端点
- 测试意图分类逻辑
- 测试请求/响应模型验证

### 集成测试
- 测试完整的Planning流程
- 测试服务间通信
- 测试Docker容器启动

### 负载测试
- 使用Locust进行压力测试
- 测试并发请求处理能力
- 测试响应时间

### 端到端测试
- 模拟真实用户场景
- 测试完整工作流程
- 测试错误恢复

---

## 十二、监控和运维

### 监控指标

**请求指标**:
- 请求总数（按模式、状态分类）
- 响应时间分布（P50, P95, P99）
- 错误率

**工具调用指标**:
- 各工具调用次数
- 工具调用成功率
- 工具调用耗时

**系统指标**:
- CPU使用率
- 内存使用率
- 磁盘I/O

### 日志规范

**结构化日志**:
- 使用JSON格式
- 包含时间戳、请求ID、用户ID
- 记录关键操作和错误

**日志级别**:
- DEBUG: 调试信息
- INFO: 关键操作
- WARNING: 警告信息
- ERROR: 错误信息

### 告警规则

**响应时间告警**: P95 > 30秒持续5分钟
**错误率告警**: 错误率 > 10%持续5分钟
**服务可用性**: 健康检查失败连续3次

---

## 十三、部署检查清单

### 部署前检查
- 所有测试通过
- Docker镜像构建成功
- 环境变量配置完整
- 知识库文件存在
- 健康检查端点正常
- API文档完整

### 部署步骤概要
1. 构建知识库（如果需要）
2. 启动所有服务（docker-compose up -d）
3. 检查服务状态（docker-compose ps）
4. 验证健康检查（curl /health）
5. 查看日志确认无错误
6. 测试API端点
7. 前端功能验证

### 部署后验证
- 服务正常运行
- API响应正常
- 前端可访问
- 日志无错误
- 监控指标正常

---

## 十四、常见问题（FAQ）

### Q1: Planning Service与Image Agent如何协同工作？

**答**: 通过主Backend的意图识别，自动路由到不同的服务：
- 用户询问规划问题 → Planning Service
- 用户上传图片 → Image Agent
- 主Backend统一处理，前端无需关心后端路由

### Q2: 如何更新知识库？

**答**:
1. 将新文档放入 src/data/ 目录
2. 重新运行构建脚本（或通过API触发重建）
3. 重启Planning Service加载新知识库

### Q3: 如何监控服务性能？

**答**:
1. 查看日志: docker-compose logs -f planning-service
2. 访问健康检查: curl http://localhost:8003/health
3. 查看Prometheus指标（如已配置）
4. LangSmith追踪（需配置API Key）

### Q4: 服务崩溃如何恢复？

**答**:
1. Docker会自动重启（restart: unless-stopped）
2. 手动重启: docker-compose restart planning-service
3. 查看崩溃原因: docker-compose logs --tail=100 planning-service

### Q5: 如何选择工作模式？

**答**:
- **自动模式**: AI根据问题复杂度自动选择
- **快速模式**: 适合简单问题、快速浏览
- **深度模式**: 适合复杂决策、需要详细分析

---

## 十五、参考资料

### 技术文档
- FastAPI官方文档
- LangChain Agent文档
- ChromaDB文档
- Docker Compose文档

### 项目文档
- CLAUDE.md - 项目整体说明
- src/rag/README.md - RAG模块说明
- src/rag/docs/ - 详细技术文档

---

## 十六、变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-16 | 1.0.0 | 初始版本，完成服务化规划 |
| 2026-01-16 | 1.1.0 | 简化文档，移除代码示例 |

---

**下一步行动**: 开始阶段1实施，创建Planning Service基础框架
