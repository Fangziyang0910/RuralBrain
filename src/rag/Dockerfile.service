# Planning Service Dockerfile
# 独立的乡村规划咨询服务微服务
ARG PYTHON_VERSION=3.13
FROM python:${PYTHON_VERSION}-slim

# 设置工作目录
WORKDIR /app

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    SERVICE_PORT=8003 \
    SERVICE_HOST=0.0.0.0

# 配置阿里云镜像源（Debian Trixie）
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    apt-get clean

# 安装系统依赖（使用重试机制）
RUN export http_proxy= && \
    export https_proxy= && \
    export HTTP_PROXY= && \
    export HTTPS_PROXY= && \
    apt-get update --fix-missing -o Acquire::Retries=3 -o Acquire::http::Timeout=60 && \
    apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 复制项目依赖文件
COPY pyproject.toml .

# 安装 Python 依赖（只安装 RAG 和 API 相关依赖）
# 分步安装以提高稳定性，使用重试机制
RUN pip install --no-cache-dir --upgrade pip --retries 5 --timeout 120 && \
    pip install --no-cache-dir --retries 5 --timeout 120 \
    fastapi uvicorn pydantic pydantic-settings python-multipart python-dotenv \
    -i https://pypi.tuna.tsinghua.edu.cn/simple/ && \
    pip install --no-cache-dir --retries 5 --timeout 180 \
    langchain langchain-deepseek langchain-zhipuai langgraph langsmith \
    langchain-chroma langchain-huggingface langchain-text-splitters \
    -i https://pypi.tuna.tsinghua.edu.cn/simple/ && \
    pip install --no-cache-dir --retries 5 --timeout 180 \
    chromadb sentence-transformers python-pptx pypdf python-docx \
    filetype requests rich \
    -i https://pypi.tuna.tsinghua.edu.cn/simple/

# 复制应用代码
COPY src/ ./src/
COPY knowledge_base/ ./knowledge_base/

# 创建非 root 用户
RUN useradd --create-home --shell /bin/bash appuser && \
    chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8003

# 健康检查
HEALTHCHECK --interval=30s --timeout=30s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8003/health || exit 1

# 启动命令
CMD ["python", "-m", "uvicorn", "src.rag.service.main:app", "--host", "0.0.0.0", "--port", "8003"]
